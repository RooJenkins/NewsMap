import 'dotenv/config'
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

// Panama location data
const PANAMA = {
  name: 'Panama',
  type: 'country',
  lat: 8.5380,
  lng: -80.7821,
  country: 'Panama'
}

// Comprehensive Panama summary for November 2025 - "Rest is Politics" style
const PANAMA_SUMMARY = `# Panama: The Canal Nobody Can Control

Here's the bizarre geopolitical reality of November 2025: the Panama Canal—that narrow strip of water connecting two oceans and carrying 40% of all U.S. container traffic—has become a diplomatic flashpoint between Washington and Panama City. President José Raúl Mulino, who took office in May 2024 promising to be "nobody's puppet," is now fielding threats from the U.S. Embassy about visa revocations, pushback from China hawks in Washington, and an $8.5 billion canal modernization plan that requires threading the needle between America's security paranoia and Beijing's checkbook diplomacy. Meanwhile, the canal itself is literally running out of water, forcing a decade-long infrastructure gamble that will reshape global shipping—assuming the political turbulence doesn't derail it first.

**The Trump Confrontation**

The drama started in December 2024 when then President-elect Donald Trump declared that Panama Canal passage rates were too high and warned against Chinese control of the waterway. Trump's threat? "We'll demand that the Panama Canal be returned to us, in full, quickly and without question." Mulino's response was swift and unequivocal: "Every square meter of the Panama Canal and its adjacent zones belongs to Panama and will continue to belong to Panama. The sovereignty and independence of our country are not negotiable." It was a bold move—essentially telling the incoming U.S. president to back off.

Fast forward to February 2025, and U.S. Secretary of State Marco Rubio arrives in Panama City with a message: President Trump has made a "preliminary determination" that Chinese Communist Party influence over the Panama Canal area represents a treaty violation. The 1977 Carter-Torrijos Treaties guaranteed the canal's neutrality and transferred control to Panama—but now Washington is arguing that Chinese-operated port facilities at both ends of the canal constitute a backdoor takeover. Rubio specifically cited Hutchison Ports, a Hong Kong-based company (with alleged CCP ties) that operates container terminals at Balboa on the Pacific side and Cristóbal on the Atlantic side.

By October 2025, the situation escalated further. Mulino publicly alleged that someone at the U.S. Embassy was threatening to revoke visas for Panamanian officials—a hardball tactic designed to pressure Panama into limiting its economic ties with China. Mulino's frustration was palpable: "This is not coherent with the good relationship I aspire to maintain with the United States." It's a classic squeeze play: Washington wants Panama to choose sides, but Panama's economy is deeply integrated with Chinese investment, particularly in infrastructure. The canal isn't just a waterway—it's a symbol of Panamanian sovereignty, hard-won after decades of U.S. control, and no president can afford to be seen as giving it away.

**The Water Crisis and the $8.5 Billion Gamble**

But the geopolitical drama obscures a more fundamental problem: the Panama Canal is running out of water. Between late 2022 and 2024, severe El Niño-induced drought forced the canal authority to slash the number of daily transits from 38 to as low as 22, causing massive shipping delays and costing the global economy billions. The canal uses about 200 million liters of freshwater per ship transit—water that comes from Gatún Lake and other reservoirs, which also supply drinking water to Panama City's 2 million residents. When rainfall drops, it's a zero-sum game between the canal and the capital's taps.

In response, the Panama Canal Authority unveiled a monumental 10-year, $8.5 billion modernization plan. The centerpiece: a $1.2 billion dam on the Río Indio, approved in January 2025, designed to create a new reservoir that will secure water supplies during dry seasons. The plan also includes two massive new container terminals—Corozal and Telfers—that will add 5-6 million TEUs (twenty-foot equivalent units) of annual capacity and create an estimated 17,000 jobs. There's even a $4 billion liquefied petroleum gas (LPG) pipeline project to reduce the number of LPG tankers transiting the canal, freeing up valuable slots for container ships.

Sounds great, right? Except there's a catch: the Río Indio dam will displace thousands of Indigenous and rural Panamanians, sparking fierce local opposition. Environmental groups warn that the dam could disrupt ecosystems and fail to deliver promised water security if climate change accelerates droughts beyond current projections. A 2025 Northeastern University study found that without aggressive greenhouse gas reductions, the canal faces increasing risk of shipping disruptions even with the new reservoir. The authority is essentially betting $8.5 billion that it can engineer its way out of a climate crisis—but if rainfall patterns shift more dramatically than expected, the investment could fall short.

**The Economic Pressure Cooker**

For Panama, the stakes couldn't be higher. The canal generates roughly $4-5 billion annually—about 6% of the country's GDP and a critical source of government revenue. The U.S. is the canal's largest customer, accounting for approximately 73% of cargo traffic, with around $270 billion in goods passing through each year. But China is Panama's second-largest trading partner and a major investor in ports, logistics, and infrastructure. Panama recognized China diplomatically in 2017, severing ties with Taiwan, and Beijing has been generous with financing ever since.

Mulino, who won the presidency as the stand-in candidate for disqualified former president Ricardo Martinelli, faces a delicate balancing act. He needs U.S. goodwill to keep trade flowing and avoid punitive measures, but he also needs Chinese investment to fund infrastructure projects and keep the economy humming. Panama's economy rebounded strongly from the drought, with the canal reporting "outstanding" performance in fiscal year 2025—transits, cargo tonnage, and revenues all surged as water levels recovered. But the long-term trajectory depends on completing the Río Indio project, building the new terminals, and navigating the U.S.-China rivalry without getting crushed between the two superpowers.

Adding to the pressure: Panama will hold a rotational seat on the UN Security Council in 2025-26, giving it a global platform. Mulino has signaled he intends to leverage this position to raise Panama's international profile and advocate for canal neutrality. But it also puts Panama in the spotlight at a time when U.S.-China tensions are at their peak. Every vote, every statement, every diplomatic gesture will be scrutinized in Washington and Beijing.

**The International Angle**

The Panama Canal is a rare choke point in global trade—one of only a handful of waterways (along with the Suez Canal, the Strait of Hormuz, and the Strait of Malacca) that can paralyze the world economy if disrupted. For the United States, the canal is a strategic asset, even if it's no longer American-owned. U.S. military and commercial interests depend on reliable, affordable access. The idea that Chinese companies control port facilities at both ends of the canal is, from Washington's perspective, a national security nightmare—even if those companies are technically private and subject to Panamanian law.

For China, the canal represents a critical node in its Belt and Road Initiative. Hutchison Ports' operations aren't just about profits—they're about ensuring Chinese goods can reach U.S. markets efficiently and that Beijing has a foothold in Latin America's most strategic piece of infrastructure. If the U.S. could pressure Panama into restricting Chinese port operations, it would be a significant geopolitical win and a warning to other countries weighing Chinese investment.

For global shipping companies, the canal's water crisis is an operational headache. The 2023-24 drought caused massive delays and forced some vessels to reroute around South America's Cape Horn, adding weeks to journey times and millions in fuel costs. The modernization plan is welcome news, but the timeline stretches to 2035, and climate projections suggest droughts could intensify before the new infrastructure is ready. Shippers are already diversifying routes and considering alternative scenarios—what happens if the canal becomes unreliable?

**The Bottom Line**

Panama is caught in a perfect storm of geopolitical pressure, climate vulnerability, and economic dependency. The canal is simultaneously a national treasure, a strategic prize for great powers, and a piece of infrastructure at the mercy of rainfall patterns. President Mulino's assertion that he's "nobody's puppet" sounds defiant, but the reality is that Panama has limited room to maneuver. If he leans too far toward China, the U.S. could impose economic penalties or visa restrictions. If he caves to Washington's demands, he risks Chinese investment drying up and domestic backlash over sovereignty.

The Río Indio dam and the broader modernization plan are Panama's best bet to secure the canal's future, but they're also politically and environmentally contentious. The canal authority is betting that engineering can overcome climate risk, but recent research suggests that may be optimistic without global emissions reductions.

What to watch: Will the U.S. escalate pressure on Panama, potentially invoking the Carter-Torrijos Treaties to demand restrictions on Chinese port operations? Will the Río Indio dam project proceed on schedule, or will local opposition and environmental concerns delay it? And critically, will the next major drought hit before the new reservoir is ready? For now, the canal is operating smoothly, revenues are strong, and Mulino is holding the line on sovereignty. But the underlying tensions—water scarcity, great power rivalry, and economic vulnerability—aren't going away. Panama may control the canal, but increasingly, it's the canal that controls Panama's fate.`

// Extract issues from the summary (looking for ** headings)
const ISSUES = [
  "The Trump Confrontation",
  "The Water Crisis and the $8.5 Billion Gamble",
  "The Economic Pressure Cooker",
  "The International Angle"
]

// Main execution
async function updatePanamaSummary() {
  console.log('Updating Panama summary with November 2025 "Rest is Politics" style analysis...\n')

  try {
    // Store in database
    await prisma.locationSummary.upsert({
      where: {
        name_type_category: {
          name: PANAMA.name,
          type: PANAMA.type,
          category: 'all'
        }
      },
      create: {
        name: PANAMA.name,
        type: PANAMA.type,
        country: PANAMA.country,
        lat: PANAMA.lat,
        lng: PANAMA.lng,
        category: 'all',
        summary: PANAMA_SUMMARY,
        issues: JSON.stringify(ISSUES),
        topStories: JSON.stringify([]),
        storyCount: 0,
        updatedAt: new Date(),
        createdAt: new Date()
      },
      update: {
        summary: PANAMA_SUMMARY,
        issues: JSON.stringify(ISSUES),
        topStories: JSON.stringify([]),
        storyCount: 0,
        updatedAt: new Date()
      }
    })

    console.log('✅ Panama summary updated successfully!')
    console.log(`\nSummary length: ${PANAMA_SUMMARY.length} characters`)
    console.log(`Issues identified: ${ISSUES.length}`)
    console.log(`\nPreview:`)
    console.log(PANAMA_SUMMARY.split('\n').slice(0, 15).join('\n'))
    console.log('...\n')

  } catch (error) {
    console.error('❌ Failed to update Panama summary:', error)
    throw error
  }
}

updatePanamaSummary()
  .catch(console.error)
  .finally(() => prisma.$disconnect())
